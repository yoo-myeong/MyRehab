# MyRehab

## 👉 목적

**웹**, **스마트매트**, **컨트롤러**를 사용해 자가 재활 치료를 보조하여 부족한 재활 시설 인프라 환경에 기여

<br>

## 🔎 프로젝트 개요

 
### 구성
+ Web
  + 웹캠으로 입력되는 사용자의 자세를 머신러닝한 모델을 기반으로 분석하여 자세의 정확성을 판단한다. 컨트롤러로 할 수 있는 재활 게임을 웹에서 제공한다. 커뮤니티를 통해 사용자 간 재활에 관한 정보공유가 가능하다.
+ 스마트매트
  + 매트의 LED를 점등하여 다음 동작을 안내하고, 각 지점에 부착된 압력센서로 사용자의 균형을 측정하여 자세를 교정한다.
+ 컨트롤러 
  + MPU6050을 부착해 roll, pitch, yaw를 측정해서 자세 교정과 손목 재활 게임에 활용하며 사용자가 버튼을 누르는 힘을 압력센서로 측정해서 손가락 재활 게임에 사용한다.

 
<br>

## 📹 시연영상

클릭하면 유튜브로 이동 ⬇

[![MyRehab_시연영상](http://img.youtube.com/vi/qF2fW21TfUo/0.jpg)](https://youtu.be/qF2fW21TfUo?t=0s) 

<br>

## 🧐 자세한 개발 내용

[WEB](./web.md)

[SmartMat](./smartmat.md)

[Controller](./controller.md)

<br>

## 🔨 트러블슈팅

+ **firebase update 속도 개선**

  wemosD1에서 firebase에 update를 하거나 read를 하기 위해선 이메일 토큰 인증을 거친 뒤 진행되기 때문에 한 번의 동작에 2~3초 정도의 시간이 소요된다. 처음에는LED 24개를 제어하기 위해서 LED 1번부터 24번까지의 문서와, 압력센서 1~24번 문서를 만들어 값을 저장했다. 이렇게 할 경우 <u>wemosD1이 한 번 루프를 돌 때 약 40초 동안 update가 진행됐다.</u>
  
  시간을 단축시키기 위해 센서값을 하나의 배열로 만들어 저장했고 이를 firebase에 올리려고 시도했지만, wemosD1에서 firebase로 update를 도와주는 esp8266라이브러리로는 배열을 update 할 수가 없었다.
  
  **배열 형태를 띄는 문자열**은 **javascript에서 JSON.parse() 함수**를 통해 쉽게 배열로 변환해서 활용할 수 있다. 이를 활용하기 위해 배열형태 그대로 문자열로 바꾸는 ```arrToString```함수를 만들었다. 예를들어 [12,150,333]이라는 배열을 arrToString함수에 넣으면 "[12,150,333]"의 문자열을 반환한다. 압력센서값을 배열에 저장하고, arrToString함수를 적용시킨뒤 firebase에 update해서 1초내로 모든 동작이 완료되도록 구현했다.


+ **변화하는 데이터 가져오기**
  
  스마트매트에서 압력 값을 측정한 뒤 firebase에 update하면 Web은 그 값을 읽어서 html에 값을 시각화하여 표시한다. 만약 웹에서 반복적으로 firebase의 데이터를 가져오는 동작을 수행시키면 다른 필요한 함수가 동작하지 못하는 경우가 발생한다. 
  
  firebase 공식 문서에서 **특정 문서의 데이터에 변화가 생길 때만 값을 가져오는 함수**를 찾아 사용했다. 
  
  참조하는 문서 객체의 ```.on``` 을 사용하면 ```snapshot```에 변화 상태를 담을 수 있었고 ```snapshot.val()```로 변화된 값이 무엇인지 확인할 수 있었다.
