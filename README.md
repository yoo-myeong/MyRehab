# MyRehab

### 👉 목적

웹과 자체 개발 보조도구를 사용해 자가 재활 운동의 어려움을 해결하여 **부족한 재활 시설 인프라 환경에 기여**

<br>

### 🔎 프로젝트 개요

 자가 재활치료를 보조하고 꾸준한 상지 재활을 도와줄 **MyRehab(마이리햅)** 을 제작했다. MyRehab은 [스마트 운동매트]()와 [컨트롤러]() 그리고 이들과 연동되는 [웹]()으로 구성되어 있다. 
 
**스마트 운동매트**는 재활치료 동작 수행을 도와주기 위해 LED를 점등하여 다음 스텝을 안내하고, 각 지점에 부착된 압력센서로 사용자의 균형을 측정하여 자세를 교정한다.
 
**컨트롤러**는 MPU6050을 부착해 roll, pitch, yaw를 측정해서 자세 교정과 손목 재활 게임에 활용하며 사용자가 버튼을 누르는 힘을 압력센서로 측정해서 손가락 재활 게임에 사용한다.
 
**웹**은 재활치료 동작을 머신러닝한 모델을 Javascript로 불러온 뒤, 웹캠으로 입력되는 사용자의 자세를 분석해서 자세의 정확성을 판단한다. 그래프와 캘린더를 활용한 스케줄링이 가능하며 지루해하기 쉽고 가볍게 여길 수 있는 상지 재활치료를 꾸준히 수행하도록 유도하기 위해서 컨트롤러를 활용한 재활 게임을 제공한다. 마지막으로 커뮤니티를 통해 사용자 간 재활에 관한 정보공유가 가능하다.
 
<br>

### 📹 시연영상

*클릭하면 유튜브로 이동*

[![MyRehab_시연영상](http://img.youtube.com/vi/qF2fW21TfUo/0.jpg)](https://youtu.be/qF2fW21TfUo?t=0s) 

<br>

### 🔨 트러블슈팅

+ **firebase update 속도 개선**

  wemosD1에서 firebase에 update를 하거나 read를 하기 위해선 이메일 토큰 인증을 거친 뒤 진행되기 때문에 한 번의 동작에 2~3초 정도의 시간이 소요된다. 이를 해결하기 위해 buffersize를 높이고 비동기로 update를 진행하여 속도를 1초대로 개선했다. 문제는 update를 해야하는 양이었다. LED 24개를 제어하기 위해서 LED 1번부터 24번까지의 데이터를 저장해야 했으며 압력센서 24개의 값을 저장하기 위해서 24개의 문서를 만들어 저장했기 때문에 wemosD1이 한 번 루프를 돌 때 약 40초 동안 update가 진행되야 했다. wemosD1의 초당 연산 수는 100번 이하로 반복되는 for문을 돌리기에 충분히 빨랐기 때문에 이를 활용하여 센서값을 하나의 배열로 만들어 저장했고 이를 firebase에 올리려고 시도했다. 하지만 firebase realtime database에 esp8266라이브러리로는 배열을 update 할 수가 없었다. **배열 형태를 띄는 문자열**은 **javascript에서 JSON.parse() 함수**를 통해 쉽게 배열로 변환해서 활용할 수 있기에 배열형태를 그대로 문자열로 바꿔 firebase에 update해서 24개의 LED 상태를 한번의 update로 끝냈으며, 24개의 압력센서 아날로그 값 역시 한 번으로 update를 마무리 할 수 있었다.

+ **변화하는 데이터 가져오기**
  
  웹에서 데이터를 가져오는 경우는 스마트매트에서 압력센서값을 firebase에 update하는 경우이다. 만약 웹에서 반복적으로 firebase의 데이터를 가져오는 동작을 수행시키면 다른 필요한 함수가 동작하지 못하는 경우가 발생한다. 이를 해결하기 위해서 **‘press/’ 문서의 데이터에 변화가 생길 때만 값을 가져오는 함수**를 찾았다. firebase함수에서는 참조하는 문서 객체의 **on 함수**를 사용해서 **snapshot에 변화를 저장**할 수 있었고 **snapshot.val()로 변화된 값**이 무엇인지 확인할 수 있었다.
